<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VSAT Satellite Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Consolas', 'SF Mono', 'Monaco', monospace;
    background: #0d1117;
    color: #c9d1d9;
    overflow-x: hidden;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    background: #161b22;
    border-bottom: 1px solid #30363d;
  }
  .header h1 {
    font-size: 18px;
    font-weight: 600;
    color: #f0f6fc;
    letter-spacing: 0.5px;
  }
  .header .status {
    font-size: 12px;
    color: #8b949e;
  }
  .header .status .dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #3fb950;
    margin-right: 6px;
    vertical-align: middle;
  }
  .header .status .dot.loading {
    background: #d29922;
    animation: pulse 1s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* Filter bar */
  .filters {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 20px;
    background: #161b22;
    border-bottom: 1px solid #30363d;
    flex-wrap: wrap;
  }
  .filters select, .filters input {
    background: #0d1117;
    color: #c9d1d9;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 6px 10px;
    font-family: inherit;
    font-size: 13px;
    outline: none;
  }
  .filters select:focus, .filters input:focus {
    border-color: #58a6ff;
  }
  .filters label {
    font-size: 12px;
    color: #8b949e;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .filters label input[type="checkbox"] {
    accent-color: #58a6ff;
  }
  .orbit-toggles {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .orbit-toggles .tag {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
  }
  .tag-geo { background: #f0883e22; color: #f0883e; }
  .tag-meo { background: #58a6ff22; color: #58a6ff; }
  .tag-leo { background: #3fb95022; color: #3fb950; }

  /* Map */
  #map {
    width: 100%;
    height: 55vh;
    min-height: 350px;
    border-bottom: 1px solid #30363d;
  }
  .leaflet-container { background: #0d1117; }

  /* Table */
  .table-container {
    overflow-x: auto;
    padding: 0 20px 20px;
  }
  .table-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
  }
  .table-header h2 {
    font-size: 14px;
    font-weight: 600;
    color: #f0f6fc;
  }
  .table-header .count {
    font-size: 12px;
    color: #8b949e;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  thead th {
    text-align: left;
    padding: 8px 12px;
    color: #8b949e;
    font-weight: 600;
    border-bottom: 1px solid #30363d;
    position: sticky;
    top: 0;
    background: #0d1117;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
  }
  thead th:hover { color: #c9d1d9; }
  tbody tr {
    cursor: pointer;
    transition: background 0.15s;
  }
  tbody tr:hover { background: #161b22; }
  tbody td {
    padding: 6px 12px;
    border-bottom: 1px solid #21262d;
    white-space: nowrap;
  }
  .num { text-align: right; font-variant-numeric: tabular-nums; }

  /* Popup */
  .leaflet-popup-content-wrapper {
    background: #161b22 !important;
    color: #c9d1d9 !important;
    border: 1px solid #30363d !important;
    border-radius: 8px !important;
    font-family: inherit !important;
  }
  .leaflet-popup-tip { background: #161b22 !important; }
  .leaflet-popup-content { font-size: 12px; line-height: 1.6; }
  .leaflet-popup-content b { color: #f0f6fc; }
  .popup-orbit {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 8px;
    font-size: 10px;
    font-weight: 700;
  }

  /* Range panel */
  .range-panel {
    display: none;
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 8px;
    padding: 16px;
    margin: 0 20px 16px;
  }
  .range-panel.visible { display: block; }
  .range-panel h3 { font-size: 13px; color: #f0f6fc; margin-bottom: 8px; }
  .range-form {
    display: flex;
    gap: 8px;
    align-items: end;
    flex-wrap: wrap;
  }
  .range-form .field { display: flex; flex-direction: column; gap: 2px; }
  .range-form .field label { font-size: 11px; color: #8b949e; }
  .range-form .field input {
    background: #0d1117;
    color: #c9d1d9;
    border: 1px solid #30363d;
    border-radius: 4px;
    padding: 4px 8px;
    font-family: inherit;
    font-size: 12px;
    width: 100px;
  }
  .range-form button {
    background: #238636;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 6px 14px;
    font-family: inherit;
    font-size: 12px;
    cursor: pointer;
  }
  .range-form button:hover { background: #2ea043; }
  .range-result {
    margin-top: 10px;
    font-size: 12px;
    line-height: 1.8;
  }

  /* Geolocate panel */
  .geo-panel {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 8px;
    padding: 16px;
    margin: 12px 20px;
  }
  .geo-panel h3 {
    font-size: 14px;
    color: #f0f6fc;
    margin-bottom: 4px;
  }
  .geo-panel .subtitle {
    font-size: 11px;
    color: #8b949e;
    margin-bottom: 12px;
  }
  .ping-rows { display: flex; flex-direction: column; gap: 8px; }
  .ping-row {
    display: flex;
    gap: 8px;
    align-items: end;
    flex-wrap: wrap;
    padding: 8px;
    background: #0d1117;
    border-radius: 6px;
    border: 1px solid #21262d;
  }
  .ping-row .field { display: flex; flex-direction: column; gap: 2px; }
  .ping-row .field label { font-size: 10px; color: #8b949e; }
  .ping-row .field input, .ping-row .field select {
    background: #161b22;
    color: #c9d1d9;
    border: 1px solid #30363d;
    border-radius: 4px;
    padding: 4px 8px;
    font-family: inherit;
    font-size: 12px;
  }
  .ping-row .field input { width: 110px; }
  .ping-row .field select { width: 200px; }
  .ping-row .remove-btn {
    background: none;
    border: none;
    color: #f85149;
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
  }
  .geo-buttons {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }
  .geo-buttons button {
    border: none;
    border-radius: 6px;
    padding: 6px 14px;
    font-family: inherit;
    font-size: 12px;
    cursor: pointer;
  }
  .btn-primary { background: #238636; color: #fff; }
  .btn-primary:hover { background: #2ea043; }
  .btn-secondary { background: #30363d; color: #c9d1d9; }
  .btn-secondary:hover { background: #3d444d; }
  .btn-danger { background: #da3633; color: #fff; }
  .btn-danger:hover { background: #f85149; }
  .geo-result {
    margin-top: 12px;
    font-size: 12px;
    line-height: 1.8;
    padding: 10px;
    background: #0d1117;
    border-radius: 6px;
    border: 1px solid #21262d;
    display: none;
  }
  .geo-result.visible { display: block; }

  /* Tracker panel */
  .tracker-panel {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 8px;
    padding: 16px;
    margin: 12px 20px;
  }
  .tracker-panel h3 {
    font-size: 14px;
    color: #f0f6fc;
    margin-bottom: 4px;
  }
  .tracker-panel .subtitle {
    font-size: 11px;
    color: #8b949e;
    margin-bottom: 12px;
  }
  .tracker-form {
    display: flex;
    gap: 8px;
    align-items: end;
    flex-wrap: wrap;
  }
  .tracker-form .field { display: flex; flex-direction: column; gap: 2px; }
  .tracker-form .field label { font-size: 10px; color: #8b949e; }
  .tracker-form .field input {
    background: #0d1117;
    color: #c9d1d9;
    border: 1px solid #30363d;
    border-radius: 4px;
    padding: 4px 8px;
    font-family: inherit;
    font-size: 12px;
    width: 120px;
  }
  .tracker-buttons {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }
  .tracker-status {
    margin-top: 12px;
    font-size: 12px;
    line-height: 1.8;
    padding: 10px;
    background: #0d1117;
    border-radius: 6px;
    border: 1px solid #21262d;
    display: none;
  }
  .tracker-status.visible { display: block; }
  .tracker-progress {
    height: 4px;
    background: #21262d;
    border-radius: 2px;
    margin-bottom: 8px;
    overflow: hidden;
  }
  .tracker-progress-bar {
    height: 100%;
    background: #58a6ff;
    border-radius: 2px;
    transition: width 0.5s ease;
  }
  .confidence-box {
    margin-top: 10px;
    padding: 10px;
    background: #23863622;
    border: 1px solid #23863666;
    border-radius: 6px;
  }
  .confidence-box .big-num {
    font-size: 22px;
    font-weight: 700;
    color: #3fb950;
  }
  .round-entry {
    padding: 6px 0;
    border-bottom: 1px solid #21262d;
    display: flex;
    gap: 12px;
    align-items: center;
    font-size: 11px;
  }
  .round-entry:last-child { border-bottom: none; }
  .round-num {
    color: #8b949e;
    min-width: 50px;
  }
  .round-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 4px;
  }
</style>
</head>
<body>

<div class="header">
  <h1>VSAT Satellite Tracker</h1>
  <div class="status">
    <span class="dot loading" id="statusDot"></span>
    <span id="statusText">Loading fleet...</span>
  </div>
</div>

<div class="filters">
  <select id="providerFilter">
    <option value="">All Providers</option>
  </select>

  <div class="orbit-toggles">
    <label><input type="checkbox" id="toggleGEO" checked>
      <span class="tag tag-geo">GEO</span></label>
    <label><input type="checkbox" id="toggleMEO" checked>
      <span class="tag tag-meo">MEO</span></label>
    <label><input type="checkbox" id="toggleLEO" checked>
      <span class="tag tag-leo">LEO</span></label>
  </div>

  <input type="text" id="searchBox" placeholder="Search satellites..." style="width: 200px;">
</div>

<div id="map"></div>

<div class="range-panel" id="rangePanel">
  <h3>Slant Range Calculator — <span id="rangeTarget"></span></h3>
  <div class="range-form">
    <div class="field">
      <label>Observer Lat</label>
      <input type="number" id="obsLat" step="0.01" value="25.0">
    </div>
    <div class="field">
      <label>Observer Lon</label>
      <input type="number" id="obsLon" step="0.01" value="-80.0">
    </div>
    <div class="field">
      <label>Alt (km)</label>
      <input type="number" id="obsAlt" step="0.001" value="0">
    </div>
    <button onclick="calcRange()">Calculate</button>
  </div>
  <div class="range-result" id="rangeResult"></div>
</div>

<div class="geo-panel" id="geoPanel">
  <h3>Ship Geolocation from Ping RTT</h3>
  <div class="subtitle">Enter ping measurements. Subtract ground-side trace delays to isolate the satellite leg. Provide the teleport/ground station location to subtract the uplink path — what remains is the satellite-to-ship slant range. Each ping draws a range circle on the map.</div>
  <div class="ping-rows" id="pingRows">
    <div class="ping-row" data-idx="0">
      <div class="field">
        <label>Satellite</label>
        <select class="ping-sat"></select>
      </div>
      <div class="field">
        <label>Total RTT (ms)</label>
        <input type="number" class="ping-rtt" step="0.1" placeholder="e.g. 580">
      </div>
      <div class="field">
        <label>Ground delay (ms)</label>
        <input type="number" class="ping-ground" step="0.1" value="0" placeholder="from traceroute">
      </div>
      <div class="field">
        <label>Teleport Lat</label>
        <input type="number" class="ping-tp-lat" step="0.01" placeholder="e.g. 51.5">
      </div>
      <div class="field">
        <label>Teleport Lon</label>
        <input type="number" class="ping-tp-lon" step="0.01" placeholder="e.g. -0.1">
      </div>
      <div class="field">
        <label>Time (UTC, optional)</label>
        <input type="text" class="ping-time" placeholder="now">
      </div>
    </div>
  </div>
  <div class="geo-buttons">
    <button class="btn-primary" onclick="runGeolocate()">Draw Circles</button>
    <button class="btn-secondary" onclick="addPingRow()">+ Add Ping</button>
    <button class="btn-danger" onclick="clearGeolocate()">Clear</button>
    <button class="btn-secondary" onclick="loadDemo()" style="margin-left:auto;">Load Live Ping Data</button>
  </div>
  <div class="geo-result" id="geoResult"></div>
</div>

<div class="tracker-panel" id="trackerPanel">
  <h3>MEO Ship Tracker — Time-Series Geolocation</h3>
  <div class="subtitle">Track an O3b/MEO ship IP over time. Each ping round draws a slant range circle from a different satellite position. As circles accumulate, their intersection narrows to a confidence region showing the ship's estimated location.</div>
  <div class="tracker-form">
    <div class="field">
      <label>Ship IP Address</label>
      <input type="text" id="trackIP" value="185.6.111.132" placeholder="e.g. 185.6.111.132">
    </div>
    <div class="field">
      <label>Interval (sec)</label>
      <input type="number" id="trackInterval" value="60" step="30" min="30">
    </div>
    <div class="field">
      <label>Rounds</label>
      <input type="number" id="trackRounds" value="6" min="2" max="24">
    </div>
    <div class="field">
      <label>Pings/round</label>
      <input type="number" id="trackPings" value="20" min="5" max="100">
    </div>
    <div class="field">
      <label>Ground delay (ms)</label>
      <input type="number" id="trackGround" value="5" step="1">
    </div>
    <div class="field">
      <label>Teleport Lat</label>
      <input type="number" id="trackTpLat" value="49.68" step="0.01">
    </div>
    <div class="field">
      <label>Teleport Lon</label>
      <input type="number" id="trackTpLon" value="6.33" step="0.01">
    </div>
  </div>
  <div class="tracker-buttons">
    <button class="btn-primary" id="trackStartBtn" onclick="startTracking()">Start Tracking</button>
    <button class="btn-danger" id="trackStopBtn" onclick="stopTracking()" style="display:none;">Stop</button>
    <button class="btn-secondary" id="trackClearBtn" onclick="clearTracking()">Clear</button>
  </div>
  <div class="tracker-status" id="trackerStatus">
    <div class="tracker-progress"><div class="tracker-progress-bar" id="trackerProgressBar" style="width:0%"></div></div>
    <div id="trackerStatusText"></div>
    <div id="trackerRounds"></div>
    <div class="confidence-box" id="confidenceBox" style="display:none;">
      <div>Confidence Region</div>
      <div class="big-num" id="confidenceRadius">--</div>
      <div id="confidenceDetails" style="font-size:11px;color:#8b949e;margin-top:4px;"></div>
    </div>
  </div>
</div>

<div class="table-header">
  <h2>Satellite Positions</h2>
  <span class="count" id="tableCount"></span>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th data-sort="name">Name</th>
        <th data-sort="norad_id">NORAD</th>
        <th data-sort="provider">Provider</th>
        <th data-sort="lat_deg" class="num">Lat</th>
        <th data-sort="lon_deg" class="num">Lon</th>
        <th data-sort="alt_km" class="num">Alt (km)</th>
        <th data-sort="orbit_type">Orbit</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
// ---------------------------------------------------------------------------
// State
// ---------------------------------------------------------------------------
let allSatellites = [];
let markers = {};
let selectedNorad = null;
let sortCol = 'provider';
let sortAsc = true;
let refreshTimer = null;

// ---------------------------------------------------------------------------
// Map setup
// ---------------------------------------------------------------------------
const map = L.map('map', {
  center: [20, 0],
  zoom: 2,
  minZoom: 2,
  maxZoom: 10,
  worldCopyJump: true,
});
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19,
}).addTo(map);

// ---------------------------------------------------------------------------
// Colors
// ---------------------------------------------------------------------------
const orbitColor = { GEO: '#f0883e', MEO: '#58a6ff', LEO: '#3fb950' };
const orbitBg = { GEO: '#f0883e22', MEO: '#58a6ff22', LEO: '#3fb95022' };

function satIcon(orbit, selected) {
  const size = selected ? 12 : (orbit === 'GEO' ? 8 : 6);
  const color = orbitColor[orbit] || '#8b949e';
  const border = selected ? '2px solid #f0f6fc' : 'none';
  return L.divIcon({
    className: '',
    html: `<div style="width:${size}px;height:${size}px;border-radius:50%;background:${color};border:${border};"></div>`,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
  });
}

// ---------------------------------------------------------------------------
// Data loading
// ---------------------------------------------------------------------------
async function loadProviders() {
  try {
    const resp = await fetch('/api/providers');
    const data = await resp.json();
    const sel = document.getElementById('providerFilter');

    const optOps = document.createElement('optgroup');
    optOps.label = 'Operators';
    data.operators.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.name;
      opt.textContent = `${p.name.toUpperCase()} (${p.orbit})`;
      optOps.appendChild(opt);
    });
    sel.appendChild(optOps);

    const optSvc = document.createElement('optgroup');
    optSvc.label = 'Service Providers';
    data.service_providers.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.name;
      opt.textContent = `${p.name.toUpperCase()} — ${p.desc}`;
      optSvc.appendChild(opt);
    });
    sel.appendChild(optSvc);
  } catch(e) {
    console.error('Failed to load providers:', e);
  }
}

async function loadFleet() {
  const dot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  dot.classList.add('loading');
  statusText.textContent = 'Updating positions...';

  try {
    const resp = await fetch('/api/fleet');
    const data = await resp.json();
    allSatellites = data.satellites;
    dot.classList.remove('loading');
    statusText.textContent = `${data.count} satellites — ${new Date(data.time).toUTCString()}`;
    applyFilters();
  } catch(e) {
    dot.classList.remove('loading');
    statusText.textContent = 'Error loading fleet';
    console.error(e);
  }
}

// ---------------------------------------------------------------------------
// Filtering
// ---------------------------------------------------------------------------
function getFiltered() {
  const provVal = document.getElementById('providerFilter').value;
  const showGEO = document.getElementById('toggleGEO').checked;
  const showMEO = document.getElementById('toggleMEO').checked;
  const showLEO = document.getElementById('toggleLEO').checked;
  const q = document.getElementById('searchBox').value.toUpperCase().trim();

  return allSatellites.filter(s => {
    if (provVal && s.provider !== provVal) return false;
    if (s.orbit_type === 'GEO' && !showGEO) return false;
    if (s.orbit_type === 'MEO' && !showMEO) return false;
    if (s.orbit_type === 'LEO' && !showLEO) return false;
    if (q && !s.name.toUpperCase().includes(q) && !String(s.norad_id).includes(q)) return false;
    return true;
  });
}

function applyFilters() {
  const filtered = getFiltered();
  renderMap(filtered);
  renderTable(filtered);
}

// ---------------------------------------------------------------------------
// Map rendering
// ---------------------------------------------------------------------------
function renderMap(satellites) {
  // Remove old markers
  Object.values(markers).forEach(m => map.removeLayer(m));
  markers = {};

  satellites.forEach(s => {
    const m = L.marker([s.lat_deg, s.lon_deg], {
      icon: satIcon(s.orbit_type, s.norad_id === selectedNorad),
      zIndexOffset: s.orbit_type === 'GEO' ? 100 : 0,
    });

    const orbitStyle = `background:${orbitBg[s.orbit_type]};color:${orbitColor[s.orbit_type]}`;
    m.bindPopup(`
      <b>${s.name}</b><br>
      NORAD: ${s.norad_id}<br>
      Provider: ${s.provider.toUpperCase()}<br>
      <span class="popup-orbit" style="${orbitStyle}">${s.orbit_type}</span>
      Alt: ${s.alt_km.toLocaleString(undefined, {maximumFractionDigits: 1})} km<br>
      Lat: ${fmtCoord(s.lat_deg, 'NS')} &nbsp; Lon: ${fmtCoord(s.lon_deg, 'EW')}<br>
      <a href="#" onclick="openRange(${s.norad_id}, '${s.name.replace(/'/g,"\\'")}'); return false;"
         style="color:#58a6ff;">Calculate slant range</a>
    `, { maxWidth: 280 });

    m.addTo(map);
    markers[s.norad_id] = m;
  });
}

// ---------------------------------------------------------------------------
// Table rendering
// ---------------------------------------------------------------------------
function renderTable(satellites) {
  // Sort
  const sorted = [...satellites].sort((a, b) => {
    let va = a[sortCol], vb = b[sortCol];
    if (typeof va === 'string') va = va.toLowerCase();
    if (typeof vb === 'string') vb = vb.toLowerCase();
    if (va < vb) return sortAsc ? -1 : 1;
    if (va > vb) return sortAsc ? 1 : -1;
    return 0;
  });

  document.getElementById('tableCount').textContent = `${sorted.length} satellites`;

  const tbody = document.getElementById('tbody');
  tbody.innerHTML = sorted.map(s => `
    <tr onclick="panTo(${s.norad_id})" data-nid="${s.norad_id}"
        style="${s.norad_id === selectedNorad ? 'background:#161b22;' : ''}">
      <td>${s.name}</td>
      <td class="num">${s.norad_id}</td>
      <td>${s.provider.toUpperCase()}</td>
      <td class="num">${fmtCoord(s.lat_deg, 'NS')}</td>
      <td class="num">${fmtCoord(s.lon_deg, 'EW')}</td>
      <td class="num">${s.alt_km.toLocaleString(undefined, {maximumFractionDigits: 1})}</td>
      <td><span class="tag tag-${s.orbit_type.toLowerCase()}">${s.orbit_type}</span></td>
    </tr>
  `).join('');
}

function fmtCoord(deg, dirs) {
  const d = Math.abs(deg).toFixed(4);
  const dir = deg >= 0 ? dirs[0] : dirs[1];
  return `${d}\u00B0${dir}`;
}

// ---------------------------------------------------------------------------
// Interactions
// ---------------------------------------------------------------------------
function panTo(noradId) {
  const m = markers[noradId];
  if (m) {
    map.setView(m.getLatLng(), Math.max(map.getZoom(), 4), { animate: true });
    m.openPopup();
  }
}

function openRange(noradId, name) {
  selectedNorad = noradId;
  document.getElementById('rangePanel').classList.add('visible');
  document.getElementById('rangeTarget').textContent = `${name} (${noradId})`;
  document.getElementById('rangeResult').innerHTML = '';
}

async function calcRange() {
  if (!selectedNorad) return;
  const lat = parseFloat(document.getElementById('obsLat').value);
  const lon = parseFloat(document.getElementById('obsLon').value);
  const alt = parseFloat(document.getElementById('obsAlt').value) || 0;

  try {
    const resp = await fetch(`/api/range?norad_id=${selectedNorad}&lat=${lat}&lon=${lon}&alt=${alt}`);
    const data = await resp.json();
    if (data.error) {
      document.getElementById('rangeResult').innerHTML = `<span style="color:#f85149">Error: ${data.error}</span>`;
      return;
    }
    const r = data.range;
    document.getElementById('rangeResult').innerHTML = `
      Slant range: <b>${r.slant_range_km.toLocaleString(undefined, {maximumFractionDigits: 1})} km</b><br>
      Elevation: <b>${r.elevation_deg.toFixed(2)}&deg;</b> &nbsp;
      Azimuth: <b>${r.azimuth_deg.toFixed(2)}&deg;</b><br>
      One-way delay: <b>${r.one_way_delay_ms.toFixed(3)} ms</b> &nbsp;
      Round-trip: <b>${r.round_trip_delay_ms.toFixed(3)} ms</b>
    `;

    // Draw line from observer to satellite
    const sat = data.satellite;
    L.polyline([[lat, lon], [sat.lat_deg, sat.lon_deg]], {
      color: '#58a6ff', weight: 1, dashArray: '5,5', opacity: 0.6,
    }).addTo(map);
  } catch(e) {
    document.getElementById('rangeResult').innerHTML = `<span style="color:#f85149">Request failed</span>`;
  }
}

// ---------------------------------------------------------------------------
// Sort headers
// ---------------------------------------------------------------------------
document.querySelectorAll('th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.sort;
    if (sortCol === col) {
      sortAsc = !sortAsc;
    } else {
      sortCol = col;
      sortAsc = true;
    }
    // Update header arrows
    document.querySelectorAll('th[data-sort]').forEach(h => {
      h.textContent = h.textContent.replace(/ [▲▼]$/, '');
    });
    th.textContent += sortAsc ? ' ▲' : ' ▼';
    applyFilters();
  });
});

// ---------------------------------------------------------------------------
// Filter event listeners
// ---------------------------------------------------------------------------
document.getElementById('providerFilter').addEventListener('change', applyFilters);
document.getElementById('toggleGEO').addEventListener('change', applyFilters);
document.getElementById('toggleMEO').addEventListener('change', applyFilters);
document.getElementById('toggleLEO').addEventListener('change', applyFilters);

let searchTimeout;
document.getElementById('searchBox').addEventListener('input', () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(applyFilters, 250);
});

// ---------------------------------------------------------------------------
// Auto-refresh
// ---------------------------------------------------------------------------
function startRefresh() {
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(loadFleet, 30000);
}

// ---------------------------------------------------------------------------
// Geolocation from RTT
// ---------------------------------------------------------------------------
let geoCircles = [];  // Leaflet layers
let pingRowCount = 1;

const circleColors = ['#f0883e', '#58a6ff', '#3fb950', '#d2a8ff', '#f778ba', '#ffa657'];

function populateSatSelect(sel) {
  sel.innerHTML = '<option value="">Select satellite...</option>';
  const sorted = [...allSatellites].sort((a, b) => a.name.localeCompare(b.name));
  // Group GEO first (most useful for geolocation)
  const geo = sorted.filter(s => s.orbit_type === 'GEO');
  const meo = sorted.filter(s => s.orbit_type === 'MEO');
  const leo = sorted.filter(s => s.orbit_type === 'LEO');

  [['GEO', geo], ['MEO', meo], ['LEO', leo]].forEach(([label, sats]) => {
    if (sats.length === 0) return;
    const grp = document.createElement('optgroup');
    grp.label = label;
    sats.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.norad_id;
      opt.textContent = `${s.name} (${s.norad_id})`;
      grp.appendChild(opt);
    });
    sel.appendChild(grp);
  });
}

function initGeoSelects() {
  document.querySelectorAll('.ping-sat').forEach(sel => {
    if (sel.options.length <= 1) populateSatSelect(sel);
  });
}

function addPingRow() {
  const rows = document.getElementById('pingRows');
  const idx = pingRowCount++;
  const row = document.createElement('div');
  row.className = 'ping-row';
  row.dataset.idx = idx;
  row.innerHTML = `
    <div class="field">
      <label>Satellite</label>
      <select class="ping-sat"></select>
    </div>
    <div class="field">
      <label>Total RTT (ms)</label>
      <input type="number" class="ping-rtt" step="0.1" placeholder="e.g. 580">
    </div>
    <div class="field">
      <label>Ground delay (ms)</label>
      <input type="number" class="ping-ground" step="0.1" value="0">
    </div>
    <div class="field">
      <label>Teleport Lat</label>
      <input type="number" class="ping-tp-lat" step="0.01" placeholder="e.g. 51.5">
    </div>
    <div class="field">
      <label>Teleport Lon</label>
      <input type="number" class="ping-tp-lon" step="0.01" placeholder="e.g. -0.1">
    </div>
    <div class="field">
      <label>Time (UTC, optional)</label>
      <input type="text" class="ping-time" placeholder="now">
    </div>
    <button class="remove-btn" onclick="this.parentElement.remove()">&times;</button>
  `;
  rows.appendChild(row);
  populateSatSelect(row.querySelector('.ping-sat'));
}

async function runGeolocate() {
  const rows = document.querySelectorAll('.ping-row');
  const pings = [];
  rows.forEach(row => {
    const sat = row.querySelector('.ping-sat').value;
    const rtt = parseFloat(row.querySelector('.ping-rtt').value);
    const ground = parseFloat(row.querySelector('.ping-ground').value) || 0;
    const tpLat = row.querySelector('.ping-tp-lat').value;
    const tpLon = row.querySelector('.ping-tp-lon').value;
    const time = row.querySelector('.ping-time').value || null;
    if (sat && !isNaN(rtt)) {
      const p = { norad_id: parseInt(sat), rtt_ms: rtt, ground_delay_ms: ground, time };
      if (tpLat && tpLon) {
        p.teleport_lat = parseFloat(tpLat);
        p.teleport_lon = parseFloat(tpLon);
      }
      pings.push(p);
    }
  });

  if (pings.length === 0) return;

  try {
    const resp = await fetch('/api/geolocate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ pings }),
    });
    const data = await resp.json();
    drawGeoCircles(data.circles);
  } catch(e) {
    console.error('Geolocate failed:', e);
  }
}

function drawGeoCircles(circles) {
  // Clear old circles
  geoCircles.forEach(l => map.removeLayer(l));
  geoCircles = [];

  const resultDiv = document.getElementById('geoResult');
  let html = '';

  circles.forEach((c, i) => {
    if (c.error) {
      html += `<div style="color:#f85149">Ping ${i+1}: ${c.error}</div>`;
      return;
    }

    const color = circleColors[i % circleColors.length];

    // Draw the range circle
    const latlngs = c.circle.map(p => [p[0], p[1]]);
    const poly = L.polyline(latlngs, {
      color: color,
      weight: 2.5,
      opacity: 0.85,
      dashArray: null,
    }).addTo(map);
    geoCircles.push(poly);

    // Draw satellite marker with label
    const satMarker = L.circleMarker([c.satellite.lat, c.satellite.lon], {
      radius: 5,
      color: color,
      fillColor: color,
      fillOpacity: 1,
      weight: 2,
    }).addTo(map).bindTooltip(`${c.name}`, {
      permanent: false,
      className: '',
      direction: 'top',
    });
    geoCircles.push(satMarker);

    // Draw teleport marker + uplink line if provided
    if (c.teleport) {
      const tpMarker = L.circleMarker([c.teleport.lat, c.teleport.lon], {
        radius: 4,
        color: '#d29922',
        fillColor: '#d29922',
        fillOpacity: 1,
        weight: 2,
      }).addTo(map).bindTooltip('Teleport', {
        permanent: false,
        direction: 'top',
      });
      geoCircles.push(tpMarker);

      const uplinkLine = L.polyline(
        [[c.teleport.lat, c.teleport.lon], [c.satellite.lat, c.satellite.lon]],
        { color: '#d29922', weight: 1, dashArray: '4,4', opacity: 0.5 }
      ).addTo(map);
      geoCircles.push(uplinkLine);
    }

    let details = `
      <div style="border-left: 3px solid ${color}; padding-left: 8px; margin-bottom: 8px;">
        <b>${c.name}</b> (NORAD ${c.norad_id})<br>
        Measured RTT: ${c.measured_rtt_ms} ms &nbsp;
        Ground delay: ${c.ground_delay_ms} ms &nbsp;
        Sat leg RTT: ${c.satellite_leg_rtt_ms} ms<br>
        One-way through sat: ${c.one_way_through_sat_ms.toFixed(1)} ms (${c.one_way_through_sat_km.toLocaleString()} km)<br>`;
    if (c.teleport) {
      details += `Teleport → Sat (uplink): ${c.teleport.uplink_range_km.toLocaleString()} km / ${c.teleport.uplink_delay_ms.toFixed(1)} ms<br>`;
    }
    details += `<b>Ship slant range: ${c.ship_slant_range_km.toLocaleString()} km</b> &nbsp;
        Ship one-way: ${c.ship_one_way_delay_ms.toFixed(3)} ms`;
    if (!c.teleport) {
      details += `<br><span style="color:#d29922;">No teleport location — range includes uplink path. Add teleport coords for accurate circle.</span>`;
    }
    details += `</div>`;
    html += details;
  });

  // If multiple circles, find approximate intersection area
  if (circles.filter(c => !c.error).length > 1) {
    html += `<div style="color:#d2a8ff; margin-top: 4px;">Multiple circles drawn — ship location is near their intersection.</div>`;
  }

  resultDiv.innerHTML = html;
  resultDiv.classList.add('visible');

  // Fit map to show all circles
  if (geoCircles.length > 0) {
    const group = L.featureGroup(geoCircles);
    map.fitBounds(group.getBounds().pad(0.1));
  }
}

function clearGeolocate() {
  // Remove circles from map
  geoCircles.forEach(l => map.removeLayer(l));
  geoCircles = [];
  // Hide results
  document.getElementById('geoResult').classList.remove('visible');
  document.getElementById('geoResult').innerHTML = '';
  // Reset to single empty ping row
  const rows = document.getElementById('pingRows');
  rows.innerHTML = '';
  pingRowCount = 1;
  const row = document.createElement('div');
  row.className = 'ping-row';
  row.dataset.idx = '0';
  row.innerHTML = `
    <div class="field">
      <label>Satellite</label>
      <select class="ping-sat"></select>
    </div>
    <div class="field">
      <label>Total RTT (ms)</label>
      <input type="number" class="ping-rtt" step="0.1" placeholder="e.g. 580">
    </div>
    <div class="field">
      <label>Ground delay (ms)</label>
      <input type="number" class="ping-ground" step="0.1" value="0">
    </div>
    <div class="field">
      <label>Teleport Lat</label>
      <input type="number" class="ping-tp-lat" step="0.01" placeholder="e.g. 51.5">
    </div>
    <div class="field">
      <label>Teleport Lon</label>
      <input type="number" class="ping-tp-lon" step="0.01" placeholder="e.g. -0.1">
    </div>
    <div class="field">
      <label>Time (UTC, optional)</label>
      <input type="text" class="ping-time" placeholder="now">
    </div>
  `;
  rows.appendChild(row);
  populateSatSelect(row.querySelector('.ping-sat'));
}

// ---------------------------------------------------------------------------
// Demo — load real ping results from VSAT terminal scanning
// ---------------------------------------------------------------------------
const DEMO_PINGS = [
  { label: 'Thuraya Ship (188.38.58.90)', norad_id: 62483, rtt_ms: 558, ground_delay_ms: 10,
    teleport_lat: 24.2, teleport_lon: 55.7, ip: '188.38.58.90', provider: 'Thuraya' },
  { label: 'Speedcast Ship (72.2.234.197)', norad_id: 38098, rtt_ms: 615, ground_delay_ms: 10,
    teleport_lat: -31.9, teleport_lon: 115.9, ip: '72.2.234.197', provider: 'Speedcast' },
  { label: 'Marlink Ship (217.168.183.72)', norad_id: 39172, rtt_ms: 484, ground_delay_ms: 10,
    teleport_lat: 37.9, teleport_lon: 23.7, ip: '217.168.183.72', provider: 'Marlink' },
  { label: 'Castor Marine Ship 1 (185.6.111.132)', norad_id: 43231, rtt_ms: 114, ground_delay_ms: 5,
    teleport_lat: 49.68, teleport_lon: 6.33, ip: '185.6.111.132', provider: 'Castor/O3b' },
  { label: 'Castor Marine Ship 2 (185.6.111.140)', norad_id: 40079, rtt_ms: 121, ground_delay_ms: 5,
    teleport_lat: 49.68, teleport_lon: 6.33, ip: '185.6.111.140', provider: 'Castor/O3b' },
  { label: 'Castor Marine Ship 3 (185.6.111.224)', norad_id: 58346, rtt_ms: 124, ground_delay_ms: 5,
    teleport_lat: 49.68, teleport_lon: 6.33, ip: '185.6.111.224', provider: 'Castor/O3b' },
];

async function loadDemo() {
  clearGeolocate();

  const pings = DEMO_PINGS.map(p => ({
    norad_id: p.norad_id,
    rtt_ms: p.rtt_ms,
    ground_delay_ms: p.ground_delay_ms,
    teleport_lat: p.teleport_lat,
    teleport_lon: p.teleport_lon,
  }));

  try {
    const resp = await fetch('/api/geolocate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ pings }),
    });
    const data = await resp.json();

    // Enhance results with IP/provider info
    data.circles.forEach((c, i) => {
      if (!c.error) {
        c._label = DEMO_PINGS[i].label;
        c._ip = DEMO_PINGS[i].ip;
        c._provider = DEMO_PINGS[i].provider;
      }
    });

    drawGeoCirclesDemo(data.circles);
  } catch(e) {
    console.error('Demo failed:', e);
  }
}

function drawGeoCirclesDemo(circles) {
  geoCircles.forEach(l => map.removeLayer(l));
  geoCircles = [];

  const resultDiv = document.getElementById('geoResult');
  let html = '<div style="margin-bottom:8px;color:#f0f6fc;font-weight:600;">Live Ping Geolocation — 6 VSAT ships pinged from this machine</div>';

  circles.forEach((c, i) => {
    if (c.error) {
      html += `<div style="color:#f85149">Ping ${i+1}: ${c.error}</div>`;
      return;
    }

    const color = circleColors[i % circleColors.length];
    const label = c._label || c.name;
    const ip = c._ip || '';
    const prov = c._provider || '';

    // Draw the range circle
    const latlngs = c.circle.map(p => [p[0], p[1]]);
    const poly = L.polyline(latlngs, {
      color: color, weight: 2.5, opacity: 0.85,
    }).addTo(map);
    geoCircles.push(poly);

    // Satellite marker
    const satMarker = L.circleMarker([c.satellite.lat, c.satellite.lon], {
      radius: 5, color: color, fillColor: color, fillOpacity: 1, weight: 2,
    }).addTo(map).bindTooltip(c.name, { direction: 'top' });
    geoCircles.push(satMarker);

    // Teleport marker + line
    if (c.teleport) {
      const tpMarker = L.circleMarker([c.teleport.lat, c.teleport.lon], {
        radius: 4, color: '#d29922', fillColor: '#d29922', fillOpacity: 1, weight: 2,
      }).addTo(map).bindTooltip('Teleport', { direction: 'top' });
      geoCircles.push(tpMarker);
      const uplinkLine = L.polyline(
        [[c.teleport.lat, c.teleport.lon], [c.satellite.lat, c.satellite.lon]],
        { color: '#d29922', weight: 1, dashArray: '4,4', opacity: 0.4 }
      ).addTo(map);
      geoCircles.push(uplinkLine);
    }

    const warn = c.warning ? `<br><span style="color:#d29922;font-size:11px;">${c.warning}</span>` : '';
    html += `
      <div style="border-left: 3px solid ${color}; padding-left: 8px; margin-bottom: 8px;">
        <b style="color:${color}">${prov}</b> — ${ip}<br>
        Satellite: ${c.name} | RTT: ${c.measured_rtt_ms}ms | Ground: ${c.ground_delay_ms}ms<br>
        Ship range: <b>${c.ship_slant_range_km.toLocaleString()} km</b> |
        One-way: ${c.ship_one_way_delay_ms.toFixed(1)}ms${warn}
      </div>`;
  });

  resultDiv.innerHTML = html;
  resultDiv.classList.add('visible');

  if (geoCircles.length > 0) {
    const group = L.featureGroup(geoCircles);
    map.fitBounds(group.getBounds().pad(0.1));
  }
}

// ---------------------------------------------------------------------------
// MEO Ship Tracker — time-series geolocation
// ---------------------------------------------------------------------------
let activeTrackId = null;
let trackPollTimer = null;
let trackCircleLayers = [];   // accumulating circle polylines
let trackConfidenceLayer = null;  // confidence region polygon
let trackCenterMarker = null;

const trackCircleColors = [
  '#58a6ff', '#3fb950', '#f0883e', '#d2a8ff', '#f778ba', '#ffa657',
  '#79c0ff', '#56d364', '#ffa198', '#e3b341', '#bc8cff', '#ff9bce',
];

async function startTracking() {
  const ip = document.getElementById('trackIP').value.trim();
  if (!ip) return;

  const req = {
    ip: ip,
    interval_sec: parseInt(document.getElementById('trackInterval').value) || 60,
    n_rounds: parseInt(document.getElementById('trackRounds').value) || 6,
    pings_per_round: parseInt(document.getElementById('trackPings').value) || 20,
    ground_delay_ms: parseFloat(document.getElementById('trackGround').value) || 5,
    teleport_lat: parseFloat(document.getElementById('trackTpLat').value) || 49.68,
    teleport_lon: parseFloat(document.getElementById('trackTpLon').value) || 6.33,
  };

  try {
    const resp = await fetch('/api/track', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(req),
    });
    const data = await resp.json();
    activeTrackId = data.track_id;

    // Update UI
    document.getElementById('trackStartBtn').style.display = 'none';
    document.getElementById('trackStopBtn').style.display = 'inline-block';
    document.getElementById('trackerStatus').classList.add('visible');
    document.getElementById('trackerStatusText').innerHTML =
      `<span style="color:#58a6ff;">Tracking started</span> — ${ip} | ${req.n_rounds} rounds @ ${req.interval_sec}s intervals`;

    // Start polling
    pollTracking();
    trackPollTimer = setInterval(pollTracking, 3000);
  } catch(e) {
    console.error('Failed to start tracking:', e);
    document.getElementById('trackerStatusText').innerHTML =
      `<span style="color:#f85149;">Failed to start: ${e.message}</span>`;
    document.getElementById('trackerStatus').classList.add('visible');
  }
}

async function stopTracking() {
  if (!activeTrackId) return;
  try {
    await fetch(`/api/track/${activeTrackId}/stop`, { method: 'POST' });
    document.getElementById('trackStopBtn').style.display = 'none';
    document.getElementById('trackStartBtn').style.display = 'inline-block';
  } catch(e) {
    console.error('Failed to stop:', e);
  }
}

function clearTracking() {
  // Stop polling
  if (trackPollTimer) { clearInterval(trackPollTimer); trackPollTimer = null; }
  activeTrackId = null;

  // Remove map layers
  trackCircleLayers.forEach(l => map.removeLayer(l));
  trackCircleLayers = [];
  if (trackConfidenceLayer) { map.removeLayer(trackConfidenceLayer); trackConfidenceLayer = null; }
  if (trackCenterMarker) { map.removeLayer(trackCenterMarker); trackCenterMarker = null; }

  // Reset UI
  document.getElementById('trackStartBtn').style.display = 'inline-block';
  document.getElementById('trackStopBtn').style.display = 'none';
  document.getElementById('trackerStatus').classList.remove('visible');
  document.getElementById('trackerStatusText').innerHTML = '';
  document.getElementById('trackerRounds').innerHTML = '';
  document.getElementById('confidenceBox').style.display = 'none';
  document.getElementById('trackerProgressBar').style.width = '0%';
}

async function pollTracking() {
  if (!activeTrackId) return;
  try {
    const resp = await fetch(`/api/track/${activeTrackId}`);
    const data = await resp.json();
    updateTrackingUI(data);

    if (data.status === 'complete' || data.status === 'stopped') {
      clearInterval(trackPollTimer);
      trackPollTimer = null;
      document.getElementById('trackStopBtn').style.display = 'none';
      document.getElementById('trackStartBtn').style.display = 'inline-block';
    }
  } catch(e) {
    console.error('Poll error:', e);
  }
}

function updateTrackingUI(data) {
  const nRounds = data.n_rounds;
  const completed = data.completed_rounds;
  const pct = Math.round((completed / nRounds) * 100);

  // Progress bar
  document.getElementById('trackerProgressBar').style.width = pct + '%';

  // Status text
  let statusHTML = `<span style="color:#58a6ff;">${data.status}</span>`;
  statusHTML += ` — ${completed}/${nRounds} rounds | IP: ${data.ip}`;
  document.getElementById('trackerStatusText').innerHTML = statusHTML;

  // Round entries
  let roundsHTML = '';
  data.measurements.forEach((m, i) => {
    const color = trackCircleColors[i % trackCircleColors.length];
    if (m.error) {
      roundsHTML += `<div class="round-entry">
        <span class="round-num">Round ${m.round}</span>
        <span style="color:#f85149;">${m.error}</span>
      </div>`;
    } else {
      const satName = m.satellite || 'unknown';
      const range = m.ship_range_km ? m.ship_range_km.toLocaleString() + ' km' : '--';
      roundsHTML += `<div class="round-entry">
        <span class="round-num">Round ${m.round}</span>
        <span class="round-dot" style="background:${color}"></span>
        <span>${satName}</span>
        <span style="color:#8b949e;">RTT: ${m.min_rtt_ms}ms</span>
        <span style="color:#8b949e;">Range: ${range}</span>
        <span style="color:#8b949e;">${new Date(m.time).toUTCString().slice(17, 25)} UTC</span>
      </div>`;
    }
  });
  document.getElementById('trackerRounds').innerHTML = roundsHTML;

  // Draw circles on map (redraw all each poll to keep in sync)
  trackCircleLayers.forEach(l => map.removeLayer(l));
  trackCircleLayers = [];

  if (data.circles && data.circles.length > 0) {
    data.circles.forEach((c, i) => {
      const color = trackCircleColors[i % trackCircleColors.length];

      // Range circle
      if (c.circle && c.circle.length > 0) {
        const latlngs = c.circle.map(p => [p[0], p[1]]);
        const poly = L.polyline(latlngs, {
          color: color, weight: 2, opacity: 0.75,
        }).addTo(map);
        trackCircleLayers.push(poly);
      }

      // Satellite marker at time of measurement
      if (c.satellite) {
        const sm = L.circleMarker([c.satellite.lat, c.satellite.lon], {
          radius: 4, color: color, fillColor: color, fillOpacity: 0.8, weight: 1,
        }).addTo(map).bindTooltip(`${c.name} (R${i+1})`, { direction: 'top' });
        trackCircleLayers.push(sm);
      }
    });
  }

  // Confidence region
  if (trackConfidenceLayer) { map.removeLayer(trackConfidenceLayer); trackConfidenceLayer = null; }
  if (trackCenterMarker) { map.removeLayer(trackCenterMarker); trackCenterMarker = null; }

  if (data.confidence) {
    const conf = data.confidence;
    document.getElementById('confidenceBox').style.display = 'block';
    document.getElementById('confidenceRadius').textContent =
      `${conf.radius_km.toLocaleString()} km (${conf.radius_nm.toLocaleString()} nm)`;
    document.getElementById('confidenceDetails').innerHTML =
      `Center: ${conf.center_lat.toFixed(3)}, ${conf.center_lon.toFixed(3)} | ` +
      `${conf.radius_mi.toLocaleString()} miles | ${conf.n_candidates} candidate points | ` +
      `Best score: ${conf.best_score}/${data.circles.length} circles`;

    // Draw confidence polygon
    if (conf.polygon && conf.polygon.length > 0) {
      const confLatLngs = conf.polygon.map(p => [p[0], p[1]]);
      trackConfidenceLayer = L.polygon(confLatLngs, {
        color: '#3fb950',
        fillColor: '#3fb950',
        fillOpacity: 0.15,
        weight: 2,
        dashArray: '6,4',
      }).addTo(map);
      trackCircleLayers.push(trackConfidenceLayer);
    }

    // Center marker
    trackCenterMarker = L.circleMarker([conf.center_lat, conf.center_lon], {
      radius: 7, color: '#3fb950', fillColor: '#3fb950', fillOpacity: 1, weight: 2,
    }).addTo(map).bindTooltip(
      `Est. ship location<br>${conf.center_lat.toFixed(3)}, ${conf.center_lon.toFixed(3)}<br>` +
      `Confidence: ${conf.radius_km} km`,
      { direction: 'top', permanent: false }
    );
    trackCircleLayers.push(trackCenterMarker);

    // Fit map to show confidence region + circles
    if (trackCircleLayers.length > 0) {
      const group = L.featureGroup(trackCircleLayers);
      map.fitBounds(group.getBounds().pad(0.2));
    }
  } else {
    document.getElementById('confidenceBox').style.display = 'none';
    // Still fit to circles if any
    if (trackCircleLayers.length > 0) {
      const group = L.featureGroup(trackCircleLayers);
      map.fitBounds(group.getBounds().pad(0.2));
    }
  }
}

// ---------------------------------------------------------------------------
// Init
// ---------------------------------------------------------------------------
loadProviders();
loadFleet().then(() => {
  startRefresh();
  initGeoSelects();
});
</script>
</body>
</html>
